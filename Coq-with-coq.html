<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- This file documents the Software Evolution library

Copyright (C) 2014-2018 Eric Schulte and GrammaTech

Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3
or any later version published by the Free Software Foundation;
with the Invariant Section being "GNU GENERAL PUBLIC LICENSE,"
A copy of the license is included in the section entitled
"GNU Free Documentation License." -->
<!-- Created by GNU Texinfo 6.7, http://www.gnu.org/software/texinfo/ -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Coq with coq (Software Evolution Library)</title>

<meta name="description" content="Coq with coq (Software Evolution Library)">
<meta name="keywords" content="Coq with coq (Software Evolution Library)">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="makeinfo">
<link href="index.html" rel="start" title="Top">
<link href="Index.html" rel="index" title="Index">
<link href="index.html#SEC_Contents" rel="contents" title="Table of Contents">
<link href="Software-Objects.html" rel="up" title="Software Objects">
<link href="Ancestor-tracking-with-ancestral.html" rel="next" title="Ancestor tracking with ancestral">
<link href="JavaScript-with-javascript.html" rel="prev" title="JavaScript with javascript">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
blockquote.indentedblock {margin-right: 0em}
div.display {margin-left: 3.2em}
div.example {margin-left: 3.2em}
div.lisp {margin-left: 3.2em}
kbd {font-style: oblique}
pre.display {font-family: inherit}
pre.format {font-family: inherit}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
span.nolinebreak {white-space: nowrap}
span.roman {font-family: initial; font-weight: normal}
span.sansserif {font-family: sans-serif; font-weight: normal}
ul.no-bullet {list-style: none}
-->
</style>


</head>

<body lang="en">
<span id="Coq-with-coq"></span><div class="header">
<p>
Next: <a href="Ancestor-tracking-with-ancestral.html" accesskey="n" rel="next">Ancestor tracking with <code>ancestral</code></a>, Previous: <a href="JavaScript-with-javascript.html" accesskey="p" rel="prev">JavaScript with <code>javascript</code></a>, Up: <a href="Software-Objects.html" accesskey="u" rel="up">Software Objects</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>
<hr>

<span id="Coq-with-coq-and-SerAPI"></span><h4 class="subsection">2.1.6 Coq with <code>coq</code> and <code>SerAPI</code></h4>


<span id="Coq-Module-Organization"></span><h4 class="subsection">2.1.7 Coq Module Organization</h4>

<p>The &lsquo;coq&rsquo; module is split into two layers. The lower layer, implemented in
&lsquo;serapi-io.lisp&rsquo;, is strictly responsible for serialization of Coq abstract
syntax trees (ASTs). This is done with Coq SerAPI
<a href="https://github.com/ejgallego/coq-serapi">https://github.com/ejgallego/coq-serapi</a>, specifically &lsquo;sertop&rsquo;, which
allows for querying of Coq documents and serializes ASTs to S-expressions.
</p>
<p>The &lsquo;coq&rsquo; and &lsquo;coq-project&rsquo; software objects, implemented in &lsquo;coq.lisp&rsquo; and
&lsquo;coq-project.lisp&rsquo;, respectively, are higher-level abstractions built on
&lsquo;serapi-io&rsquo;. Ideally, clients should only have to construct software objects
anduse API functions provided by &lsquo;coq.lisp&rsquo; or &lsquo;coq-project.lisp&rsquo; without
having to worry about the lower-level functions.
</p>
<span id="Setting-up-SerAPI"></span><h4 class="subsection">2.1.8 Setting up SerAPI</h4>

<p>In order to construct a Coq software object, coq-serapi must be installed.
Refer to its GitHub project page for instructions. The variables
&lsquo;*sertop-path*&rsquo; and &lsquo;*sertop-args*&rsquo; must then be set. This can be done
either with &lsquo;setf&rsquo; or by setting the environment variables &lsquo;SERAPI&rsquo; and
&lsquo;COQLIB&rsquo; and invoking &lsquo;set-serapi-paths&rsquo; to update the Lisp variables.
&lsquo;SERAPI&rsquo; and &lsquo;*sertop-path*&rsquo; should point to the sertop executable.
</p>
<p>If you intend to use the Coq standard library, you will need to ensure that
sertop is started with the &lsquo;&ndash;coqlib&rsquo; flag pointing to the coq/lib
directory. This can be done either by setting the environment variable
&lsquo;COQLIB&rsquo; to that path or by setting &lsquo;*sertop-args*&rsquo; to
<code>(list ``--coqlib=/path/to/coq/lib/'')</code>. Other sertop parameters may
also be added to &lsquo;*sertop-args*&rsquo;.
</p>


<span id="Coq-Module-Organization-1"></span><h4 class="subsection">2.1.9 Coq Module Organization</h4>

<p>The &lsquo;coq&rsquo; module is split into two layers. The lower layer, implemented in
&lsquo;serapi-io.lisp&rsquo;, is strictly responsible for serialization of Coq abstract
syntax trees (ASTs) and is described in-depth in its own section.
</p>
<p>The &lsquo;coq&rsquo; and &lsquo;coq-project&rsquo; software objects, implemented in &lsquo;coq.lisp&rsquo; and
&lsquo;coq-project.lisp&rsquo;, respectively, are higher-level abstractions built on
&lsquo;serapi-io&rsquo;. Ideally, clients should only have to construct software objects
 and use API functions provided by &lsquo;coq.lisp&rsquo; or &lsquo;coq-project.lisp&rsquo; without
 having to worry about the lower-level functions.
</p>
<span id="Creating-Coq-Objects"></span><h4 class="subsection">2.1.10 Creating Coq Objects</h4>

<p>Coq software objects have the following fields:
</p>
<ul>
<li> <code>project-file</code> path to _CoqProject file
</li><li> <code>file-source</code> path to the Coq source file this object represents
</li><li> <code>imports</code> list of ASTs representing load or require statements
</li><li> <code>genome</code> list of ASTs representing the Coq source, excluding imports
</li><li> <code>ast-ids</code> list of AST IDs assigned to ASTs in the genome
</li><li> <code>fitness</code> fitness of the object last time it was evaluated

</li></ul>
<p>The recommended way to create a Coq software object is using &lsquo;from-file&rsquo;:
</p>
<div class="example">
<pre class="example">    (with-serapi ()
      (from-file (make-instance 'coq :project-file &quot;/path/to/_CoqProject&quot;)
                 &quot;/path/to/Foo.v&quot;))
</pre></div>

<p>If you don&rsquo;t have a _CoqProject file, you may omit the &lsquo;:project-file&rsquo;
keyword.
</p>
<p>Since many API functions require interactions with SerAPI, a &lsquo;with-serapi&rsquo;
macro is provided to automatically create a sertop process. This works by
binding the dynamic variable &lsquo;*serapi-process*&rsquo; to an interactive sertop
process. This is important to be aware of if you intend to use multiple
threads: each thread _must_ have its own separate sertop process (in
bordeaux-threads this may be accomplished by creating thread-local copies
with &lsquo;*default-special-bindings*&rsquo;).
</p>
<p>Each &lsquo;-I&rsquo; or &lsquo;-R&rsquo; line in _CoqProject will be automatically added to the Coq
loadpath in the sertop process. If a new sertop process is created, you must
ensure that these load paths are reset and any imports are reloaded. You can
do this with either &lsquo;set-load-paths&rsquo; (which only sets the load paths) or
&lsquo;reset-and-load-imports&rsquo; (which in addition to setting load paths also
executes import statements).
</p>
<span id="Usage-of-Coq-Objects"></span><h4 class="subsection">2.1.11 Usage of Coq Objects</h4>

<p>The ASTs of a Coq genome are lists whose elements are lists, symbols, and
strings. A &lsquo;type-safe-swap&rsquo; mutation selects two subtrees that have the same
&ldquo;tag&rdquo; (i.e., the first symbol in that list) and swaps them. Favoring this
mutation helps to cut down on type errors that would result from swapping
arbitrary subtrees.
</p>
<p>Additional mutations are forthcoming.
</p>
<p>In the AST representations provided by Coq, many statements include location
information tying AST nodes to locations in the source file. To help reduce
the size of the AST, &lsquo;from-file&rsquo; replaces the full location information with
the list &lsquo;(:loc nil)&rsquo;. This ensures that it&rsquo;s clear where the location
information was without overly cluttering the AST. The implementation of
&lsquo;lookup-source-strings&rsquo; ensures that these are removed prior to sending the
ASTs to sertop to look up source strings. The default implementations of
&lsquo;pick-bad&rsquo; and &lsquo;pick-good&rsquo; for Coq objects exclude &ldquo;located&rdquo; statements.
</p>
<p>Since sertop maintains a stateful representation of definitions that have
been loaded and Coq prevents redefinition, it is sometimes necessary to
reset the state of sertop to an earlier state. The easiest way to do this is
to use &lsquo;insert-reset-point&rsquo; to indicate that you may later want to restore
sertop to the current state, and &lsquo;reset-serapi-process&rsquo; to reset to a
previously saved state. Both &lsquo;from-file&rsquo; and &lsquo;reset-and-load-imports&rsquo; insert
a reset point before returning.
</p>

<hr>
<div class="header">
<p>
Next: <a href="Ancestor-tracking-with-ancestral.html" accesskey="n" rel="next">Ancestor tracking with <code>ancestral</code></a>, Previous: <a href="JavaScript-with-javascript.html" accesskey="p" rel="prev">JavaScript with <code>javascript</code></a>, Up: <a href="Software-Objects.html" accesskey="u" rel="up">Software Objects</a> &nbsp; [<a href="index.html#SEC_Contents" title="Table of contents" rel="contents">Contents</a>][<a href="Index.html" title="Index" rel="index">Index</a>]</p>
</div>



</body>
</html>
